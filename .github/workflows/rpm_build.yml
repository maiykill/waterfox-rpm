name: Build RPM on Waterfox Release Check

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

permissions:
  contents: write # Needed for commit and release creation
  packages: write # Needed if managing packages (optional here)

jobs:
  build_and_release_rpm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 2

      - name: Get latest Waterfox version from GitHub API
        id: fetch_latest
        run: |
          latest_tag=""
          attempt=0
          max_attempts=5

          while [[ -z "$latest_tag" || "$latest_tag" == "latest" ]]; do
            if (( attempt >= max_attempts )); then
              echo "::error::Failed to resolve latest release redirect after $max_attempts attempts."
              exit 1
            fi

            echo "Fetching latest release tag (Attempt $((attempt+1)))..."
            
            # 1. -sI gets only the headers (very fast)
            latest_tag=$(curl -sI https://github.com/BrowserWorks/Waterfox/releases/latest | \
                         grep -i '^location:' | \
                         awk -F/ '{print $NF}' | \
                         tr -d '\r')

            if [[ -z "$latest_tag" || "$latest_tag" == "latest" ]]; then
              echo "::warning::Redirect not followed correctly. Retrying..."
              sleep 5
              ((attempt++))
            fi
          done

          latest_tag=$(echo "$latest_tag" | xargs)

          echo "Detected Latest Stable: $latest_tag"
          echo "LATEST_TAG=$latest_tag" >> $GITHUB_ENV
          echo "VERSION_NO_V=${latest_tag#v}" >> $GITHUB_ENV

      - name: Check source archive on CDN
        id: check_cdn
        run: |
          url="https://cdn1.waterfox.net/waterfox/releases/${VERSION_NO_V}/Linux_x86_64/waterfox-${VERSION_NO_V}.tar.bz2"
          echo "Checking if source archive exists at $url"
          if curl --head --silent --fail "$url"; then
            echo "source_exists=true" >> $GITHUB_OUTPUT
          else
            echo "source_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Get current spec version
        id: get_spec_version
        run: |
          spec_version=$(grep -m1 '^Version:' waterfox/waterfox.spec | awk '{print $2}')
          spec_release=$(grep -m1 '^Release:' waterfox/waterfox.spec | awk '{print $2}' | cut -d'%' -f1)
          echo "Current version tag: $spec_version"
          echo "Current release tag: $spec_release"
          echo "SPEC_VERSION=$spec_version" >> $GITHUB_ENV
          echo "SPEC_RELEASE=$spec_release" >> $GITHUB_ENV

      - name: Decide on update necessity
        id: check_update
        run: |
          SPEC_CHANGED=$(git diff --name-only HEAD^ HEAD | grep "waterfox/waterfox.spec" || true)
          LAST_AUTHOR=$(git log -1 --format='%an')
          if [[ "$VERSION_NO_V" != "null" ]] && [[ "$VERSION_NO_V" != "$SPEC_VERSION" ]] && [[ "${{ steps.check_cdn.outputs.source_exists }}" == "true" ]]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Reason: New version detected ($VERSION_NO_V)"
          elif [[ -n "$SPEC_CHANGED" ]] && [[ "$LAST_AUTHOR" != "build-bot" ]]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Reason: Manual spec file change detected from $LAST_AUTHOR"
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: No update found message
        if: steps.check_update.outputs.update_needed == 'false'
        run: echo "No new Waterfox release version found; skipping build and release steps."

      - name: Update spec file version and changelog
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          current_date=$(date '+%a %b %d %Y')

          if [[ "$VERSION_NO_V" != "$SPEC_VERSION" ]]; then
            echo "New upstream version detected. Resetting to Release 1."
            sed -i "s/^Version:.*/Version:         $VERSION_NO_V/" waterfox/waterfox.spec
            sed -i "s/^Release:.*/Release:         1%{?dist}/" waterfox/waterfox.spec
            sed -i "/^%changelog$/a * $current_date build-bot <actions-build-bot@github.com> - $VERSION_NO_V-1\\n- Updated to Waterfox $VERSION_NO_V" waterfox/waterfox.spec
            echo "UPDATED_RELEASE=1" >> $GITHUB_ENV
          else
            echo "Manual bump detected. Reading current Release from file."
            ACTUAL_RELEASE=$(grep -m1 '^Release:' waterfox/waterfox.spec | awk '{print $2}' | cut -d'%' -f1)
            sed -i "/^%changelog$/a * $current_date build-bot <actions-build-bot@github.com> - $VERSION_NO_V-${ACTUAL_RELEASE}\\n- local release bump / spec update" waterfox/waterfox.spec
            echo "UPDATED_RELEASE=${ACTUAL_RELEASE}" >> $GITHUB_ENV
          fi

      - name: Commit and push updated files (sync version)
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          git config user.name "build-bot"
          git config user.email "actions-build-bot@github.com"
          git add waterfox/waterfox.spec
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "sync: waterfox.spec to ${{ env.VERSION_NO_V }}-${{ env.SPEC_RELEASE }}"
            git fetch origin ${{ github.ref_name }}
            git rebase origin/${{ github.ref_name }}
            git push origin ${{ github.ref_name }}
          fi

      - name: Install rpm and build-essential
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm build-essential

      - name: Download Waterfox source archive to rpmbuild SOURCES
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          mkdir -p ~/rpmbuild/SOURCES
          curl -fSL -o ~/rpmbuild/SOURCES/waterfox-${VERSION_NO_V}.tar.bz2 \
            https://cdn1.waterfox.net/waterfox/releases/${VERSION_NO_V}/Linux_x86_64/waterfox-${VERSION_NO_V}.tar.bz2

      - name: Copy additional source files to rpmbuild SOURCES
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cp waterfox/waterfox.desktop ~/rpmbuild/SOURCES/
          cp waterfox/policies.json ~/rpmbuild/SOURCES/
          cp LICENSE ~/rpmbuild/SOURCES/
          cp README.md ~/rpmbuild/SOURCES/

      - name: Prepare RPM build tree manually
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp waterfox/waterfox.spec ~/rpmbuild/SPECS/

      - name: Build RPM package
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          rpmbuild -ba ~/rpmbuild/SPECS/waterfox.spec

      - name: List built RPM packages
        if: steps.check_update.outputs.update_needed == 'true'
        run: ls -lh ~/rpmbuild/RPMS/x86_64/

      - name: Create GitHub Release and Upload RPM
        if: steps.check_update.outputs.update_needed == 'true'
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          tag: "${{ env.LATEST_TAG }}-${{ env.SPEC_RELEASE }}"
          name: "Waterfox ${{ env.LATEST_TAG }}-${{ env.SPEC_RELEASE }} RPM"
          artifacts: "/home/runner/rpmbuild/RPMS/x86_64/waterfox-${{ env.VERSION_NO_V }}-*.x86_64.rpm"
          body: |
            ### ðŸ“¦ Automated RPM Release
            This is an RPM build of Waterfox ${{ env.LATEST_TAG }}-${{ env.SPEC_RELEASE}} for x86_64.

            **Release Notes:**
            You can find the official changelog and release notes here:
            [Waterfox ${{ env.LATEST_TAG }} Official Notes](https://github.com/BrowserWorks/waterfox/releases/tag/${{ env.LATEST_TAG }})
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
